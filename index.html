<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Water Tracker</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --card:#0b1223; --text:#e5e7eb; --muted:#9ca3af;
    --brand:#38bdf8; --brand-2:#22d3ee; --accent:#34d399; --danger:#fb7185;
    --shadow: 0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background: radial-gradient(1200px 1200px at 100% -20%, rgba(56,189,248,.15), transparent 60%),
                radial-gradient(1200px 1200px at -20% 120%, rgba(34,211,238,.12), transparent 60%),
                var(--bg);
    color:var(--text);
  }
  .wrap{max-width:980px;margin:28px auto;padding:20px}
  header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px;}
  .title{font-size:clamp(22px,3vw,28px); font-weight:700; letter-spacing:.3px; display:flex; align-items:center; gap:10px;}
  .pill{font-size:12px; padding:4px 10px; border-radius:9999px; color:#0b0f19;
    background:linear-gradient(145deg,var(--brand),var(--brand-2)); font-weight:700; letter-spacing:.4px;}
  .panel{background:rgba(17,24,39,.6); border:1px solid rgba(148,163,184,.12); border-radius:18px; padding:16px; box-shadow:var(--shadow); backdrop-filter: blur(8px);}
  .grid{display:grid; gap:16px; grid-template-columns: 370px 1fr;}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(2,6,23,.95)); border:1px solid rgba(148,163,184,.12); border-radius:20px; padding:20px; box-shadow:var(--shadow);}
  .ring{width:230px; height:230px; margin:8px auto 14px; border-radius:50%; display:grid; place-items:center;
    background: conic-gradient(var(--brand) var(--angle), rgba(148,163,184,.12) 0); transition:.3s ease background; position:relative;}
  .ring::after{content:""; position:absolute; inset:12px; border-radius:50%; background:radial-gradient(200px 200px at 50% 20%, rgba(56,189,248,.06), transparent 50%), var(--card);
    border:1px solid rgba(148,163,184,.10);}
  .ring-inner{position:relative; z-index:1; text-align:center;}
  .big{ font-weight:800; font-size:32px}
  .sub{ color:var(--muted); font-size:13px }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .row > *{flex:1}
  .btn{cursor:pointer; border:none; padding:12px 14px; border-radius:14px;
    background:linear-gradient(160deg, rgba(56,189,248,.18), rgba(34,211,238,.14));
    color:var(--text); font-weight:700; letter-spacing:.2px; border:1px solid rgba(56,189,248,.25);
    transition:.15s transform ease,.15s filter ease;}
  .btn:hover{ transform: translateY(-1px); filter:brightness(1.06); }
  .btn:active{ transform:translateY(0) scale(.98) }
  .btn-ghost{background:transparent; border:1px dashed rgba(148,163,184,.35); color:var(--muted);}
  .btn-danger{background:linear-gradient(160deg, rgba(251,113,133,.18), rgba(244,63,94,.12)); border:1px solid rgba(251,113,133,.35);}
  .btn-ok{background:linear-gradient(160deg, rgba(52,211,153,.20), rgba(34,197,94,.15)); border:1px solid rgba(52,211,153,.40);}
  .num{background:rgba(2,6,23,.6); border:1px solid rgba(148,163,184,.18); color:var(--text); border-radius:14px; padding:12px 14px; width:100%; outline:none; font-weight:700;}
  .num::placeholder{color:var(--muted)}
  table{width:100%; border-collapse:collapse; font-size:14px}
  thead th{ text-align:left; color:var(--muted); font-weight:700; padding:8px 10px; border-bottom:1px solid rgba(148,163,184,.16)}
  tbody td{ padding:10px; border-bottom:1px dashed rgba(148,163,184,.10) }
  tbody tr:hover{ background:rgba(56,189,248,.06) }
  .kbd{background:#0f172a; border:1px solid rgba(148,163,184,.35); padding:2px 6px; border-radius:8px; font-size:12px; color:var(--text);}
  footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center }
  /* Toast do aktualizacji */
  .toast{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#0b0f19; border:1px solid rgba(148,163,184,.25); color:var(--text);
    padding:10px 12px; border-radius:12px; display:flex; gap:10px; align-items:center; box-shadow:var(--shadow)}
  .toast button{padding:8px 10px; border-radius:10px; border:1px solid rgba(56,189,248,.35); background:rgba(56,189,248,.18); color:var(--text); cursor:pointer; font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <header class="panel">
      <div class="title">ðŸ’§ Water Tracker <span class="pill">Daily</span></div>
      <div class="row" style="max-width:560px">
        <input id="date" type="date" class="num">
        <input id="goal" type="number" min="0" step="50" placeholder="Cel (ml)" class="num" title="Cel dzienny w ml">
        <button id="saveGoal" class="btn btn-ok" title="Zapisz cel dla tego dnia">Zapisz cel</button>
        <button id="resetDay" class="btn btn-danger" title="WyczyÅ›Ä‡ dzienny log (R)">Reset dnia</button>
        <button id="installBtn" class="btn btn-ghost" title="Zainstaluj jako aplikacjÄ™">Zainstaluj</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Progress & quick add -->
      <section class="card">
        <div id="ring" class="ring" style="--angle:0deg">
          <div class="ring-inner">
            <div class="big"><span id="consumedL">0.00</span> L</div>
            <div class="sub">
              <span id="consumed">0</span> / <span id="goalView">2500</span> ml
              Â· <span id="left">2500</span> ml do celu
            </div>
          </div>
        </div>

        <div class="row" style="margin:10px 0 6px">
          <button class="btn" data-add="100" title="SkrÃ³t: 1">+100 ml</button>
          <button class="btn" data-add="200" title="SkrÃ³t: 2">+200 ml</button>
          <button class="btn" data-add="500" title="SkrÃ³t: 5">+500 ml</button>
        </div>

        <div class="row">
          <input id="custom" class="num" type="number" min="1" step="10" placeholder="WÅ‚asna porcja (ml)" />
          <button id="addCustom" class="btn">Dodaj</button>
          <button id="undo" class="btn btn-ghost" title="Cofnij ostatni wpis (U)">Cofnij</button>
        </div>

        <div style="margin-top:12px; color:var(--muted); font-size:13px">
          SkrÃ³ty: <span class="kbd">1</span>=100 ml, <span class="kbd">2</span>=200 ml, <span class="kbd">5</span>=500 ml,
          <span class="kbd">U</span>=cofnij, <span class="kbd">R</span>=reset, <span class="kbd">G</span>=cel.
        </div>
      </section>

      <!-- RIGHT: History & totals -->
      <section class="card">
        <div class="row" style="margin-bottom:8px">
          <div style="flex:1; font-weight:800">Historia dnia</div>
          <button id="exportBtn" class="btn btn-ghost" title="Eksportuj JSON">Eksport</button>
          <button id="importBtn" class="btn btn-ghost" title="Import JSON">Import</button>
        </div>
        <div class="panel" style="padding:0">
          <table>
            <thead>
              <tr><th>#</th><th>Porcja (ml)</th><th>Godzina</th><th></th></tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>
      Zapis lokalny przeglÄ…darki Â· KaÅ¼dy dzieÅ„ ma wÅ‚asny log Â· ZmieÅ„ datÄ™, aby przeglÄ…daÄ‡ inne dni
    </footer>
  </div>

<!-- Toast do aktualizacji -->
<div id="updateToast" class="toast" style="display:none">
  <span>Nowa wersja dostÄ™pna</span>
  <button id="reloadBtn">OdÅ›wieÅ¼</button>
</div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);

  // ====== PWA: instalacja + SW + auto-update ======
  let deferredPrompt=null;
  const installBtn = $('#installBtn');
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.opacity = 1; });
  installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt){ alert('Na iOS: UdostÄ™pnij â†’ Do ekranu gÅ‚Ã³wnego'); return; } deferredPrompt.prompt(); deferredPrompt = null; });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').then(reg => {
      // jeÅ›li jest nowy SW -> pokaÅ¼ toast
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            $('#updateToast').style.display = 'flex';
          }
        });
      });
    });
    // klikniÄ™cie "OdÅ›wieÅ¼"
    $('#reloadBtn').addEventListener('click', () => window.location.reload());
  }

  // ====== Twoja logika aplikacji (bez zmian w UX) ======
  const dateEl = $('#date');
  const goalEl = $('#goal');
  const saveGoalBtn = $('#saveGoal');
  const resetDayBtn = $('#resetDay');
  const ring = $('#ring');
  const consumedEl = $('#consumed');
  const consumedLEl = $('#consumedL');
  const goalViewEl = $('#goalView');
  const leftEl = $('#left');
  const logBody = $('#logBody');
  const customEl = $('#custom');
  const addCustomBtn = $('#addCustom');
  const exportBtn = $('#exportBtn');
  const importBtn = $('#importBtn');
  const undoBtn = $('#undo');

  const k = d => `water:${d}`;
  const todayStr = () => new Date().toISOString().slice(0,10);

  function readDay(date){
    const raw = localStorage.getItem(k(date));
    return raw ? JSON.parse(raw) : { goal:2500, entries:[] };
  }
  function writeDay(date, data){
    localStorage.setItem(k(date), JSON.stringify(data));
  }

  function mlToL(ml){ return (ml/1000).toFixed(2); }
  function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }

  function refresh(){
    const d = dateEl.value;
    const data = readDay(d);
    const sum = data.entries.reduce((s, e) => s + e.ml, 0);
    const goal = Math.max(0, Number(data.goal)||0);

    consumedEl.textContent = sum;
    consumedLEl.textContent = mlToL(sum);
    goalViewEl.textContent = goal;
    leftEl.textContent = Math.max(0, goal - sum);

    const pct = goal ? clamp(sum/goal, 0, 1) : 0;
    ring.style.setProperty('--angle', `${pct*360}deg`);

    logBody.innerHTML = '';
    data.entries.forEach((e, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td><strong>${e.ml}</strong></td>
        <td>${new Date(e.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
        <td style="text-align:right">
          <button class="btn btn-ghost" data-del="${i}">UsuÅ„</button>
        </td>`;
      logBody.appendChild(tr);
    });

    goalEl.value = goal;
  }

  function addEntry(ml){
    ml = Math.max(1, Math.round(Number(ml)||0));
    const d = dateEl.value;
    const data = readDay(d);
    data.entries.push({ ml, t: Date.now() });
    writeDay(d, data);
    refresh();
  }
  function deleteEntry(idx){
    const d = dateEl.value;
    const data = readDay(d);
    data.entries.splice(idx,1);
    writeDay(d, data);
    refresh();
  }
  function undo(){
    const d = dateEl.value;
    const data = readDay(d);
    data.entries.pop();
    writeDay(d, data);
    refresh();
  }
  function resetDay(){
    if(!confirm('WyczyÅ›ciÄ‡ wszystkie wpisy dla tego dnia?')) return;
    const d = dateEl.value;
    const data = readDay(d);
    data.entries = [];
    writeDay(d, data);
    refresh();
  }

  dateEl.value = todayStr();
  dateEl.addEventListener('change', refresh);

  saveGoalBtn.addEventListener('click', () => {
    const d = dateEl.value;
    const data = readDay(d);
    const val = Math.max(0, Math.round(Number(goalEl.value)||0));
    data.goal = val;
    writeDay(d, data);
    refresh();
  });

  resetDayBtn.addEventListener('click', resetDay);
  undoBtn.addEventListener('click', undo);

  document.querySelectorAll('[data-add]').forEach(btn => {
    btn.addEventListener('click', () => addEntry(btn.getAttribute('data-add')));
  });
  addCustomBtn.addEventListener('click', () => {
    const v = customEl.value;
    if(v) addEntry(v);
    customEl.value = '';
    customEl.focus();
  });

  logBody.addEventListener('click', e => {
    const btn = e.target.closest('[data-del]');
    if(btn) deleteEntry(Number(btn.getAttribute('data-del')));
  });

  window.addEventListener('keydown', e => {
    if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
    if(e.key==='1') addEntry(100);
    if(e.key==='2') addEntry(200);
    if(e.key==='5') addEntry(500);
    if(e.key.toLowerCase()==='u') undo();
    if(e.key.toLowerCase()==='r') resetDay();
    if(e.key.toLowerCase()==='g') goalEl.focus();
  });

  refresh();
})();
</script>
</body>
</html>
